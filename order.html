<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>訂單</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      text-align: left
    }

    tfoot td {
      font-weight: 800
    }

    .qty {
      width: 80px
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 頂部：TAB + 搜尋欄 -->
    <div class="header">
      <div class="tabs">
        <a class="tab" href="product.html">商品頁</a>
      </div>
      <div class="tabs">
        <a class="tab" href="shoppingCart.html">購物車</a>
      </div>
      <div class="tabs">
        <a class="tab" href="order.html">訂單頁</a>
      </div>
    </div>
  </div>

  <main class="container grid" style="grid-template-columns:1fr 380px">
    <section class="card">
      <div class="space-between">
        <h2 style="margin:0;font-size:16px">訂單內容</h2>
        <div class="row">
          <input id="orderIdInput" class="input" placeholder="orderId（預設由 LocalStorage 帶入）" style="width:260px">
          <button id="load" class="btn">查詢</button>
        </div>
      </div>
      <div id="info" class="muted" style="margin-top:8px">尚未載入</div>
      <div id="itemsWrap" class="card hidden" style="margin-top:12px">
        <table id="itemsTbl">
          <thead>
            <tr>
              <th>商品</th>
              <th>單價</th>
              <th>數量</th>
              <th>小計</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="3">總計</td>
              <td id="totalCell">NT$ 0</td>
            </tr>
          </tfoot>
        </table>
        <small class="muted">* 將數量調整為 0 代表刪除該品項（僅限 ordered）。</small>
      </div>
    </section>

    <aside class="grid" style="grid-template-columns:1fr;align-content:start;gap:16px">
      <section class="card">
        <h3 style="margin:0 0 8px;font-size:15px">動作</h3>
        <div id="actionWrap" class="grid" style="grid-template-columns:1fr">
          <button id="save" class="btn">修改訂單</button>
          <button id="complete" class="btn">完成訂單</button>
          <button id="delete" class="btn">刪除訂單</button>
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px;font-size:15px">新增評論（完成訂單才能評）</h3>
        <form id="reviewForm" class="grid" style="grid-template-columns:1fr">
          <label>內容<textarea class="input" name="content" rows="3" placeholder="寫下你的心得…"></textarea></label>
          <button class="btn">送出評論</button>
        </form>
        <div id="reviewResult" class="muted" style="margin-top:8px"></div>
      </section>
    </aside>
  </main>

  <script>
    // DOM
    const BASE = "http://localhost:8080/csp";
    const orderIdInput = document.querySelector("#orderIdInput");
    const loadBtn = document.querySelector("#load");
    const infoEl = document.querySelector("#info");
    const itemsWrap = document.querySelector("#itemsWrap");
    const itemsTbody = document.querySelector("#itemsTbl tbody");
    const totalCell = document.querySelector("#totalCell");
    const saveBtn = document.querySelector("#save")
    const completeBtn = document.querySelector("#complete");
    const deleteBtn = document.querySelector("#delete");
    const reviewForm = document.querySelector("#reviewForm")
    const reviewResult = document.querySelector("#reviewResult");

    // 從 LocalStorage 拿orderId
    const lsOrderId = localStorage.getItem("orderId");
    if (lsOrderId){
      orderIdInput.value = lsOrderId;
    } 

    let currentOrder = null;
    let qtyDraft = new Map();

    // 點擊查詢
    loadBtn.addEventListener("click", async() => {
      const id = orderIdInput.value.trim();
      const res = await apiQueryOrder(id);
      if (res.returnCode !== "0000") { 
        alert("查詢失敗：" + (res.returnMsg || "")); 
        return; 
      }else{
        alert(res.returnMsg); 
      }
      currentOrder = res.data; 
      qtyDraft.clear();
      renderOrder(currentOrder);
    });

    // 點擊修改
    saveBtn.addEventListener("click", async() => {
       if (!currentOrder) return;
      const items = currentOrder.list.map(it => {
        const newQty = qtyDraft.has(it.productId) ? qtyDraft.get(it.productId) : it.quantity;
        return { productId: it.productId, quantity: newQty };
      });
      const j = await apiEditOrder(currentOrder.orderId, items);
      if (j.returnCode !== "0000") {
        alert("更新失敗：" + (j.returnMsg || ""));
        return;
      }
      qtyDraft.clear();
    });

    // 點擊完成
    completeBtn.addEventListener("click", async() => {
      if (!currentOrder) return;
      const res = await apiCompleteOrder(currentOrder.orderId);
      if (res.returnCode !== "0000") {
        alert("完成失敗：" + (res.returnMsg || ""));
        return;
      }
    });

    // 點擊刪除
    deleteBtn.addEventListener("click", async() => {
      if (!currentOrder) return;
      if (!confirm("確認刪除此訂單？")) return;
      const res = await apiDeleteOrder(currentOrder.orderId);
      if (res.returnCode !== "0000") {
        alert("刪除失敗：" + (res.returnMsg || "")); return;
      }
      alert("已刪除");
      currentOrder = null;
      itemsWrap.classList.add("hidden");
      infoEl.textContent = "已刪除";
    });

    // 點擊評論
    reviewForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentOrder) { 
        alert("請先查詢訂單"); 
        return; 
      }
      const fd = new FormData(reviewForm);
      const payload = {
        orderId: currentOrder.orderId,
        content: String(fd.get("content") || "")
      };
      const productId = Number(fd.get("productId"));
      const res = await apiAddReview(productId, payload);
      reviewResult.textContent = res.returnCode === "0000" ? "評論已送出" : "送出失敗：" + (res.returnMsg || "");
    });

    // 初次自動載入
    if (lsOrderId) loadOrder();


    // ===== 後端 API =====
    async function apiQueryOrder(orderId) {
      const res = await fetch(`${BASE}/queryOrder`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId })
      });
      return res.json();
    }

    async function apiEditOrder(orderId, items) {
      const res = await fetch(`${BASE}/editOrder`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId, items })
      });
      return res.json();
    }

    async function apiCompleteOrder(orderId) {
      const res = await fetch(`${BASE}/completeOrder`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId })
      });
      return res.json();
    }

    async function apiDeleteOrder(orderId) {
      const res = await fetch(`${BASE}/deleteOrder`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId })
      });
      return res.json();
    }

    async function apiAddReview(productId, payload) {
      const res = await fetch(`${BASE}/createReview`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(Object.assign({ productId }, payload))
      });
      return res.json();
    }

    // 訂單資料渲染
    function renderOrder(d) {
      infoEl.innerHTML = `
      <div>orderId：<strong>${d.orderId}</strong></div>
      <div>狀態：<strong>${d.status}</strong></div>
      <div class="muted">${new Date(d.createTime || Date.now()).toLocaleString()}</div>`;
      itemsWrap.classList.remove("hidden");
      itemsTbody.innerHTML = "";
      let sum = 0;

      for (const it of d.list) {
        const tr = document.createElement("tr");
        sum += it.lineAmount;
        tr.innerHTML = `
        <td>${escapeHTML(it.productName)} <span class="muted">#${it.productId}</span></td>
        <td>NT$ ${Number(it.unitPrice).toLocaleString()}</td>
        <td>
          <input class="input qty" type="number" min="0" max="99" value="${it.quantity}"
                   data-id="${it.productId}"/>
        </td>
        <td>NT$ ${(Number(it.unitPrice) * Number(it.quantity)).toLocaleString()}</td>`;
        itemsTbody.appendChild(tr);
      }
      totalCell.textContent = "NT$ " + sum.toLocaleString();


      // 填入可評論商品
      const sel = reviewForm.querySelector('select[name="productId"]');
      sel.innerHTML = d.list.map(it =>
        `<option value="${it.productId}">${escapeHTML(it.productName)} (#${it.productId})</option>`
      ).join("");

      // 綁定輸入事件
      itemsTbody.querySelectorAll(".qty").forEach(inp => {
        inp.addEventListener("change", (e) => {
          const id = Number(e.target.dataset.id);
          qtyDraft.set(id, clamp(Number(e.target.value || 0), 0, 99));
        });
      });
    }
    // 工具
    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function escapeHTML(s) {
      return String(s ?? "").replace(/[&<>"']/g,
        c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
    }
  </script>

</body>

</html>